<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Attendance System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .pulsing {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: .5;
            }
        }
        .status-badge {
            transition: background-color 0.5s ease-in-out, color 0.5s ease-in-out;
        }
        button:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex items-center justify-center min-h-screen py-8">
    <div class="w-full max-w-md mx-auto bg-white rounded-xl shadow-lg p-8">
        <div class="flex flex-col items-center">
            <!-- Header -->
            <svg class="w-16 h-16 text-blue-500 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M8.288 15.043A5.242 5.242 0 017.5 14.25a5.25 5.25 0 01-1.37-1.033m1.37 1.033c.338.338.724.624 1.14.858M8.288 15.043c.416.234.872.42 1.352.558m1.712-2.353a5.243 5.243 0 01-.14 1.343m.14-1.343a5.243 5.243 0 011.343-.14m-1.343.14c.416.234.872.42 1.352.558m0 0a5.25 5.25 0 001.37 1.033m-1.37-1.033a5.243 5.243 0 001.212-.81m-1.212.81c.338.338.724.624 1.14.858m-8.14-8.14a5.243 5.243 0 011.212.81m-1.212-.81a5.243 5.243 0 00-1.343.14m1.343-.14c-.416-.234-.872-.42-1.352-.558m0 0a5.25 5.25 0 00-1.37-1.033m1.37 1.033c-.338-.338-.724-.624-1.14-.858M12 12a2.25 2.25 0 100-4.5 2.25 2.25 0 000 4.5z" />
            </svg>
            <h1 class="text-2xl font-bold mb-2">Automated Attendance</h1>
            <p class="text-gray-500 mb-6">Select your class and start the scan.</p>

            <!-- Class Selector -->
            <div class="w-full mb-6">
                 <label for="class-division" class="block text-sm font-medium text-gray-700 mb-1">Class Division</label>
                 <select id="class-division" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                     <option value="IT-A">IT-A</option>
                     <option value="IT-B" selected>IT-B</option>
                     <option value="CS-A">CS-A</option>
                     <option value="CS-B">CS-B</option>
                 </select>
            </div>
            
            <!-- Scan Button -->
            <button id="scanButton" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg transition duration-300 flex items-center justify-center" disabled>
                <span id="scan-text">Loading...</span>
            </button>
            
             <!-- Status Message -->
            <div id="status" class="mt-4 text-sm text-center text-gray-600 h-10"></div>
            
            <!-- Analytics Summary -->
            <div id="analytics-summary" class="w-full mt-4 p-3 bg-gray-50 border rounded-lg hidden">
                <!-- content filled by JS -->
            </div>

            <!-- Student List -->
            <div class="w-full mt-4">
                <h2 class="text-lg font-semibold mb-2 text-center">Attendance Roster</h2>
                <div id="studentList" class="bg-gray-50 rounded-lg p-3 max-h-60 overflow-y-auto border">
                    <p class="text-center text-gray-500">Connecting to database...</p>
                </div>
            </div>

            <!-- Save Button -->
            <button id="saveButton" class="w-full mt-4 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 hidden">
                Save Attendance
            </button>

             <!-- Helper to add initial data -->
            <div id="seed-container" class="mt-4 text-center">
                 <button id="seedButton" class="text-xs text-gray-500 hover:text-blue-500">Initialize/Seed Database</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Your web app's Firebase configuration from your project
        const firebaseConfig = {
            apiKey: "AIzaSyA4rGlHhneYX2ILxoFBUed7zmV-uv48uyM",
            authDomain: "attendance-system-36917.firebaseapp.com",
            projectId: "attendance-system-36917",
            storageBucket: "attendance-system-36917.firebasestorage.app",
            messagingSenderId: "129607548150",
            appId: "1:129607548150:web:182e21e03e793dc08840d7",
            measurementId: "G-PHTMBK2DD4"
        };

        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, doc, getDoc, setDoc, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- DOM Elements ---
        const scanButton = document.getElementById('scanButton');
        const scanText = document.getElementById('scan-text');
        const status = document.getElementById('status');
        const studentList = document.getElementById('studentList');
        const classDivisionSelector = document.getElementById('class-division');
        const analyticsSummary = document.getElementById('analytics-summary');
        const saveButton = document.getElementById('saveButton');
        const seedButton = document.getElementById('seedButton');
        const seedContainer = document.getElementById('seed-container');

        // --- App State ---
        let scanInterval;
        let currentRoster = [];
        let presentDeviceIds = new Set();
        
        // --- Authentication ---
        onAuthStateChanged(auth, user => {
            if (user) {
                console.log("Authentication successful. User UID:", user.uid);
                scanButton.disabled = false;
                scanText.textContent = "Start Attendance Scan";
                studentList.innerHTML = `<p class="text-center text-gray-500">Select a class to begin.</p>`;
            } else {
                console.log("User is not signed in. Attempting anonymous sign-in...");
                signInAnonymously(auth).catch(error => {
                    console.error("Anonymous sign-in failed:", error);
                    status.textContent = "Error: Could not connect to authentication service.";
                });
            }
        });

        // --- Event Listeners ---
        scanButton.addEventListener('click', async () => {
            if (scanButton.disabled) return;
            
            clearInterval(scanInterval);
            saveButton.classList.add('hidden');
            analyticsSummary.classList.add('hidden');
            presentDeviceIds.clear();

            const selectedDivision = classDivisionSelector.value;
            status.textContent = `Fetching roster for ${selectedDivision}...`;
            console.log(`Attempting to fetch doc: rosters/${selectedDivision}`);

            try {
                const rosterRef = doc(db, "rosters", selectedDivision);
                const rosterDoc = await getDoc(rosterRef);
                
                console.log(`Firestore document exists: ${rosterDoc.exists()}`);

                if (!rosterDoc.exists() || !rosterDoc.data().students || rosterDoc.data().students.length === 0) {
                    status.innerHTML = `No roster found for ${selectedDivision}.<br>Please click "Initialize/Seed Database" first.`;
                    studentList.innerHTML = `<p class="text-center text-red-500 font-semibold">Roster not found in the database.</p>`;
                    console.warn(`Document rosters/${selectedDivision} does not exist or is empty.`);
                    return;
                }

                currentRoster = rosterDoc.data().students;
                console.log("Roster fetched successfully:", currentRoster);
                setupForScan(currentRoster);
                simulateScan(currentRoster);

            } catch (error) {
                console.error("Error fetching roster from Firestore:", error);
                status.innerHTML = `Error fetching roster. Check console for details.<br>(Is your project set up correctly?)`;
                studentList.innerHTML = `<p class="text-center text-red-500 font-semibold">Could not connect to the database.</p>`;
            }
        });
        
        saveButton.addEventListener('click', async () => {
            if (!currentRoster.length) return;
            
            const absentStudents = currentRoster.filter(s => !presentDeviceIds.has(s.deviceId));
            const presentStudents = currentRoster.filter(s => presentDeviceIds.has(s.deviceId));
            
            const attendanceRecord = {
                division: classDivisionSelector.value,
                createdAt: serverTimestamp(),
                total: currentRoster.length,
                presentCount: presentStudents.length,
                absentCount: absentStudents.length,
                present: presentStudents.map(s => ({ rollNo: s.rollNo, name: s.name })),
                absent: absentStudents.map(s => ({ rollNo: s.rollNo, name: s.name }))
            };

            try {
                saveButton.disabled = true;
                saveButton.textContent = "Saving...";
                const docRef = await addDoc(collection(db, "attendance"), attendanceRecord);
                console.log("Attendance recorded with ID: ", docRef.id);
                status.textContent = "Attendance saved successfully!";
                saveButton.textContent = "Saved!";
            } catch (error) {
                console.error("Error saving attendance: ", error);
                status.textContent = "Error saving attendance.";
                 saveButton.disabled = false;
                 saveButton.textContent = "Save Attendance";
            }
        });

        seedButton.addEventListener('click', async () => {
            const sampleData = {
                "IT-A": [ { rollNo: "A01", name: "Rahul Sharma", deviceId: "ita-001" }, { rollNo: "A02", name: "Priya Patel", deviceId: "ita-002" }, { rollNo: "A03", name: "Amit Singh", deviceId: "ita-003" }, ],
                "IT-B": [ { rollNo: "B01", name: "Anjali Mehta", deviceId: "itb-001" }, { rollNo: "B02", name: "Deepak Gupta", deviceId: "itb-002" }, { rollNo: "B03", name: "Kavita Nair", deviceId: "itb-003" }, ],
                "CS-A": [ { rollNo: "C01", name: "Sanjay Kumar", deviceId: "csa-001" }, { rollNo: "C02", name: "Geeta Yadav", deviceId: "csa-002" }, ],
                "CS-B": [ { rollNo: "D01", name: "Neha Agarwal", deviceId: "csb-001" }, { rollNo: "D02", name: "Arun Khanna", deviceId: "csb-002" }, ]
            };
            status.textContent = "Seeding database...";
            seedButton.disabled = true;
            try {
                for (const division in sampleData) {
                    await setDoc(doc(db, "rosters", division), { students: sampleData[division] });
                }
                status.textContent = "Database seeded successfully!";
                seedContainer.style.display = 'none';
            } catch (error) {
                console.error("Error seeding database: ", error);
                status.textContent = "Error seeding database. Check console.";
                seedButton.disabled = false;
            }
        });


        // --- UI Functions ---
        function setupForScan(roster) {
            scanButton.disabled = true;
            classDivisionSelector.disabled = true;
            scanButton.classList.add('pulsing');
            scanText.textContent = 'Scanning...';
            status.textContent = 'Simulating scan for student devices...';
            
            studentList.innerHTML = '';
            roster.forEach(student => {
                const studentEl = document.createElement('div');
                studentEl.id = `student-${student.deviceId}`;
                studentEl.className = 'flex items-center justify-between p-2 border-b last:border-b-0';
                studentEl.innerHTML = `
                    <div>
                        <span class="font-bold text-gray-700">${student.rollNo}</span>
                        <span class="ml-2 text-gray-600">${student.name}</span>
                    </div>
                    <span class="status-badge text-xs font-semibold px-2 py-1 rounded-full bg-red-100 text-red-800">ABSENT</span>
                `;
                studentList.appendChild(studentEl);
            });
            updateAnalytics(0, roster.length, roster.length);
        }

        function simulateScan(roster) {
            const presentStudents = [...roster].sort(() => 0.5 - Math.random()).slice(0, Math.floor(Math.random() * (roster.length + 1)));
            let detectedCount = 0;

            scanInterval = setInterval(() => {
                if (detectedCount < presentStudents.length) {
                    const studentToMark = presentStudents[detectedCount];
                    markStudentPresent(studentToMark.deviceId);
                    presentDeviceIds.add(studentToMark.deviceId);
                    detectedCount++;
                    updateAnalytics(detectedCount, roster.length - detectedCount, roster.length);
                } else {
                    clearInterval(scanInterval);
                    scanComplete();
                }
            }, 400); 
        }
        
        function markStudentPresent(deviceId) {
            const studentEl = document.getElementById(`student-${deviceId}`);
            if (studentEl) {
                const statusBadge = studentEl.querySelector('.status-badge');
                statusBadge.textContent = 'PRESENT';
                statusBadge.classList.remove('bg-red-100', 'text-red-800');
                statusBadge.classList.add('bg-green-100', 'text-green-800');
            }
        }
        
        function updateAnalytics(present, absent, total) {
            analyticsSummary.classList.remove('hidden');
            analyticsSummary.innerHTML = `
                <div class="flex justify-around text-center">
                    <div>
                        <p class="text-xs text-gray-500">PRESENT</p>
                        <p class="text-xl font-bold text-green-600">${present}</p>
                    </div>
                    <div>
                        <p class="text-xs text-gray-500">ABSENT</p>
                        <p class="text-xl font-bold text-red-600">${absent}</p>
                    </div>
                    <div>
                        <p class="text-xs text-gray-500">TOTAL</p>
                        <p class="text-xl font-bold text-gray-700">${total}</p>
                    </div>
                </div>`;
        }

        function scanComplete() {
            scanButton.disabled = false;
            classDivisionSelector.disabled = false;
            scanButton.classList.remove('pulsing');
            scanText.textContent = 'Start New Scan';
            status.textContent = 'Scan complete. Ready to save.';
            saveButton.classList.remove('hidden');
            saveButton.disabled = false;
            saveButton.textContent = "Save Attendance";
        }
    </script>
</body>
</html>

