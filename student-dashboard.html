<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Student Dashboard</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style> body { font-family: 'Inter', sans-serif; } </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center p-6">

<div class="w-full max-w-3xl bg-white rounded-xl shadow-lg p-6">
    <h1 class="text-2xl font-bold mb-4">Attendance Dashboard</h1>
    <p id="welcome" class="text-gray-600 mb-6"></p>

    <div class="mb-6">
        <canvas id="attendanceChart" height="150"></canvas>
    </div>

    <div>
        <h2 class="text-lg font-semibold mb-2">Attendance Records</h2>
        <div id="attendanceRecords" class="bg-gray-50 rounded-lg p-4 max-h-80 overflow-y-auto border">
            Loading records...
        </div>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getFirestore, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

const firebaseConfig = {
    apiKey: "AIzaSyA4rGlHhneYX2ILxoFBUed7zmV-uv48uyM",
    authDomain: "attendance-system-36917.firebaseapp.com",
    projectId: "attendance-system-36917",
    storageBucket: "attendance-system-36917.firebasestorage.app",
    messagingSenderId: "129607548150",
    appId: "1:129607548150:web:182e21e03e793dc08840d7"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

const params = new URLSearchParams(window.location.search);
const rollNo = params.get('rollNo');
const name = params.get('name');
const division = params.get('division');

document.getElementById('welcome').textContent = `Welcome, ${name} (${rollNo}) - Class ${division}`;

async function fetchAttendance() {
    const q = query(collection(db, "attendance"), where("division", "==", division));
    const snapshot = await getDocs(q);

    let presentCount = 0;
    const recordsContainer = document.getElementById('attendanceRecords');
    recordsContainer.innerHTML = "";

    const labels = [];
    const data = [];

    snapshot.forEach(doc => {
        const record = doc.data();
        const isPresent = record.present.some(s => s.rollNo === rollNo);
        if (isPresent) presentCount++;

        labels.push(new Date(record.createdAt?.seconds * 1000).toLocaleDateString() || "Record");
        data.push(isPresent ? 1 : 0);

        const recEl = document.createElement('div');
        recEl.className = "flex justify-between p-2 border-b last:border-b-0";
        recEl.innerHTML = `
            <span>${new Date(record.createdAt?.seconds * 1000).toLocaleString() || "Date"}</span>
            <span class="${isPresent ? 'text-green-600' : 'text-red-600'}">${isPresent ? 'Present' : 'Absent'}</span>
        `;
        recordsContainer.appendChild(recEl);
    });

    new Chart(document.getElementById('attendanceChart'), {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Attendance (1 = Present, 0 = Absent)',
                data: data,
                backgroundColor: data.map(v => v ? 'rgba(34,197,94,0.7)' : 'rgba(239,68,68,0.7)'),
            }]
        },
        options: { scales: { y: { ticks: { stepSize: 1, beginAtZero: true, max: 1 } } } }
    });
}

onAuthStateChanged(auth, user => {
    if (user) fetchAttendance();
    else signInAnonymously(auth).catch(console.error);
});
</script>
</body>
</html>
